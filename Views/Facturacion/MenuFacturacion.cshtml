@model IEnumerable<BibTaller.Clases.EstrucPago.Factura>

@{
    ViewBag.Title = "Historial de Facturacion";
}

<div class="card-header bg-transparent border-0 text-center pb-3">
    <h4 class="text-success mb-3">Historial de Facturaciones</h4>
    <hr />
</div>

<div class="container-fluid py-3">
    <div class="row">
        <!-- LEFT: Chart and Filters -->
        <div class="col-lg-8 col-md-7 mb-4">

            <h5 class="text-success mb-3">Filtros de Búsqueda</h5>
            <form asp-action="MenuFacturacion" method="get" class="mb-3">
                <div class="row align-items-end px-3">
                    <div class="col-md-4">
                        <label for="tipoPago" class="form-label">Método de Pago</label>
                        <select id="tipoPago" name="tipoPago" class="form-select bg-dark text-light border-light">
                            <option value="">-- Seleccionar --</option>
                            <option value="Pago_Credito">Pago a crédito</option>
                            <option value="Pago_Contado">Pago con Efectivo</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="clienteId" class="form-label">ID Cliente</label>
                        <input type="text" id="clienteId" name="clienteId" class="form-control bg-dark text-light border-light" placeholder="Ingresa ID del cliente" />
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="submit" class="btn btn-primary mt-3 filter-btn">Aplicar Filtros</button>
                    </div>
                </div>
            </form>

            <div class="row m-3 mt-5 mb-4">
                <hr />
            </div>

            <div class="card bg-dark text-light shadow-lg border-success mb-4">
                <div class="card-header bg-success text-dark fw-bold">
                    Vista Simplificada
                </div>
                <table class="table table-dark table-hover table-bordered mb-5">
                    <thead class="table-success text-dark">
                        <tr>
                            <th>Id Orden</th>
                            <th>Fecha Generación</th>
                            <th>TipoPago</th>
                            <th>Total</th>
                            <th>Id Cliente</th>
                        </tr>
                    </thead>

                    <tbody>

                    <!--Aquí se debe usar un ciclo para traer el modelo-->
                        @foreach (var factura in Model.Select((value, index) => new { value, index })) {
                            var idOrden = factura.value.OrdenPagada.IdOrden;
                            var fechaGen = factura.value.Fecha;
                            var tipoPago = factura.value.TipoPago;
                            var total = factura.value.MontoPagado;
                            var idCliente = factura.value.OrdenPagada.Reparacion.Carro.Propietario.Id;

                            <tr class="p-1" onclick="showDetails(@factura.index)">

                                <th>@idOrden</th>
                                <th>@fechaGen.ToString("dd/MM/yyyy")</th>
                                <th>@tipoPago.ToString()</th>
                                <th>@total.ToString("C")</th>
                                <th>@idCliente</th>

                            </tr>
                        
                        }

                    </tbody>
                
                </table>
            </div>
        </div>

        <!-- RIGHT: Detailed collapsible info -->
        <div class="col-lg-4 col-md-5">
            <h5 class="text-success mb-3">Detalles</h5>

            <div id="detailsContainer" class="details-container bg-dark rounded-3 p-3 shadow-sm">
                
            </div>
        </div>
    </div>


    <script>

        const facturas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
        
        function showDetails(index) {
            const factura = facturas[index];
            const orden = factura.OrdenPagada;
            const carro = orden.Reparacion.Carro;
            const propietario = carro.Propietario;

            // 1️⃣ Build HTML dynamically
            const html = `
                <details open>
                    <summary class="text-success fw-semibold">Información General</summary>
                    <div class="mt-2 ps-3 text-light">
                        <p><strong>Propietario:</strong> ${propietario.Nombre}</p>
                        <p><strong>ID Propietario:</strong> ${propietario.Id}</p>
                        <p><strong>Teléfono:</strong> ${propietario.Telefono}</p>
                    </div>

                    <details class="ms-3 mt-2">
                        <summary class="text-success fw-semibold">Datos del Vehículo</summary>
                        <div class="mt-2 ps-3 text-light">
                            <p><strong>Marca:</strong> ${carro.Marca}</p>
                            <p><strong>Modelo:</strong> ${carro.Modelo}</p>
                            <p><strong>Placa:</strong> ${carro.Placa}</p>

                        </div>
                    </details>
                </details>

                <details>
                    <summary class="text-success fw-semibold">Repuestos Utilizados</summary>
                    <ul class="mt-2 ps-4 text-light">
                        ${orden.Reparacion.RepuestosUtilizados.map(r =>
                            `<li>${r.Nombre} - $${r.Costo.toLocaleString()}</li>`).join('')}
                    </ul>
                </details>

                <details>
                    <summary class="text-success fw-semibold">Mecánicos Encargados</summary>
                    <ul class="mt-2 ps-4 text-light">
                        ${orden.Reparacion.MecanicosEncargados.map(m =>
                            `<li>${m.Nombre} (${m.Especialidad})</li>`).join('')}
                    </ul>
                </details>
            `;

            // 2️⃣ Insert into container
            const contenedorDetalles = document.getElementById("detailsContainer");
            contenedorDetalles.innerHTML = html;
        }
    </script>


</div>

<style>
    body {
        background-color: #0f0f0f;
        color: #d0d0d0;
        font-family: "Segoe UI", sans-serif;
        font-size: 0.93rem;
    }

    h3 {
        font-weight: 600;
    }

    .filter-btn {
        background-color: transparent;
        border: 1.5px solid #00ff7f;
        border-radius: 10px;
        color: #00ff7f;
        padding: 6px 14px;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

        .filter-btn:hover {
            background-color: #00ff7f;
            color: #0f0f0f;
            box-shadow: 0 0 8px #00ff7f;
            transform: translateY(-1px);
        }

    .table-container {
        border: 1px solid #00ff7f33;
        overflow-x: auto;
    }

    .table th, .table td {
        vertical-align: middle;
        text-align: center;
    }

    .details-container {
        max-height: 75vh;
        overflow-y: auto;
        border: 1px solid #00ff7f33;
    }

    details {
        background-color: #141414;
        border-radius: 6px;
        margin-bottom: 8px;
        padding: 8px 10px;
        border: 1px solid #00ff7f22;
    }

    summary {
        cursor: pointer;
        font-size: 1rem;
        user-select: none;
    }

        summary:hover {
            color: #00ff7f;
            text-shadow: 0 0 5px #00ff7f;
        }

    details[open] summary {
        color: #00ff7f;
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-thumb {
        background-color: #00ff7f55;
        border-radius: 10px;
    }
</style>